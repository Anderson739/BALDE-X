<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FREE FIRE HTML5 - ULTIMATE EDITION</title>
    <style>
        :root {
            --primary: #ff4d00;
            --ui-bg: rgba(0, 0, 0, 0.6);
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #1a1a1a; touch-action: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        canvas { display: block; }

        /* INTERFACE UTILISATEUR (HUD) */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }
        .stats {
            position: absolute; top: 10px; left: 10px; color: white;
            background: var(--ui-bg); padding: 10px; border-radius: 5px;
        }
        .minimap-container {
            position: absolute; top: 10px; right: 10px;
            width: 150px; height: 150px; background: rgba(0,0,0,0.8);
            border: 2px solid #555; overflow: hidden;
        }
        #hp-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 25px; background: #333; border: 2px solid white;
        }
        #hp-bar { width: 100%; height: 100%; background: #2ecc71; transition: width 0.3s; }
        
        /* TOUCH CONTROLS (JOYSTICKS) */
        .joystick-zone {
            position: absolute; bottom: 20px; width: 150px; height: 150px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            pointer-events: auto;
        }
        #move-stick { left: 30px; }
        #shoot-stick { right: 30px; }
        .stick-knob {
            width: 50px; height: 50px; background: rgba(255,255,255,0.5);
            border-radius: 50%; position: absolute; top: 50px; left: 50px;
        }

        /* MENUS */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; color: white;
        }
        button {
            padding: 15px 40px; font-size: 24px; background: var(--primary);
            color: white; border: none; border-radius: 50px; cursor: pointer;
            margin-top: 20px; font-weight: bold; text-transform: uppercase;
        }
        #kill-feed {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            color: #ff4d00; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="hud">
    <div class="stats">
        <div id="alive-txt">VIVANTS: 50</div>
        <div id="kills-txt">KILLS: 0</div>
    </div>
    <div id="kill-feed"></div>
    <div class="minimap-container"><canvas id="minimap"></canvas></div>
    <div id="hp-container"><div id="hp-bar"></div></div>
    
    <div id="move-stick" class="joystick-zone"><div class="stick-knob" id="move-knob"></div></div>
    <div id="shoot-stick" class="joystick-zone"><div class="stick-knob" id="shoot-knob"></div></div>
</div>

<div id="overlay">
    <h1 style="font-size: 60px; margin: 0;">FREE FIRE <span style="color:var(--primary)">LITE</span></h1>
    <p>Survivez jusqu'au bout. Utilisez le joystick gauche pour bouger et le droit pour tirer.</p>
    <button onclick="startGame()">COMMENCER LE MATCH</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/**
 * MOTEUR AUDIO (Sons synthétiques complexes)
 */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const sounds = {
    shoot: () => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(220, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    },
    hit: () => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    },
    pickup: () => {
        const osc = audioCtx.createOscillator();
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
};

/**
 * CONFIGURATION DU JEU
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap');
const mCtx = mCanvas.getContext('2d');

const WORLD_SIZE = 3000;
let player = { 
    x: WORLD_SIZE/2, y: WORLD_SIZE/2, 
    hp: 100, maxHp: 100, size: 20, speed: 5, 
    angle: 0, kills: 0, weapon: 'MP40' 
};

let enemies = [];
let bullets = [];
let items = [];
let obstacles = [];
let zone = { x: WORLD_SIZE/2, y: WORLD_SIZE/2, r: WORLD_SIZE/2, targetR: WORLD_SIZE/2 };
let gameRunning = false;
let camera = { x: 0, y: 0 };

// Joysticks state
let moveInput = { x: 0, y: 0 };
let shootInput = { x: 0, y: 0, active: false };

/**
 * INITIALISATION
 */
function initGame() {
    // Créer des obstacles (Bâtiments)
    for(let i=0; i<40; i++) {
        obstacles.push({
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            w: 100 + Math.random() * 200,
            h: 100 + Math.random() * 200
        });
    }

    // Créer du loot (Soins)
    for(let i=0; i<50; i++) {
        items.push({
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            type: 'MEDKIT'
        });
    }

    // Créer des bots
    for(let i=0; i<49; i++) {
        enemies.push({
            id: i,
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            hp: 100,
            size: 20,
            speed: 3 + Math.random() * 2,
            targetAngle: Math.random() * Math.PI * 2,
            lastShot: 0
        });
    }
}

/**
 * GESTION TACTILE
 */
function setupJoysticks() {
    const handleStick = (e, knobId, callback) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = e.target.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.hypot(dx, dy);
        const maxDist = rect.width / 2;

        if (dist > maxDist) {
            dx = (dx / dist) * maxDist;
            dy = (dy / dist) * maxDist;
        }

        document.getElementById(knobId).style.transform = `translate(${dx}px, ${dy}px)`;
        callback(dx / maxDist, dy / maxDist);
    };

    const resetStick = (knobId, callback) => {
        document.getElementById(knobId).style.transform = `translate(0px, 0px)`;
        callback(0, 0);
    };

    document.getElementById('move-stick').addEventListener('touchmove', (e) => {
        handleStick(e, 'move-knob', (nx, ny) => { moveInput.x = nx; moveInput.y = ny; });
    });
    document.getElementById('move-stick').addEventListener('touchend', () => resetStick('move-knob', (nx, ny) => { moveInput.x = 0; moveInput.y = 0; }));

    document.getElementById('shoot-stick').addEventListener('touchstart', () => shootInput.active = true);
    document.getElementById('shoot-stick').addEventListener('touchmove', (e) => {
        handleStick(e, 'shoot-knob', (nx, ny) => { shootInput.x = nx; shootInput.y = ny; });
    });
    document.getElementById('shoot-stick').addEventListener('touchend', () => {
        shootInput.active = false;
        resetStick('shoot-knob', (nx, ny) => { shootInput.x = 0; shootInput.y = 0; });
    });
}

/**
 * BOUCLE DE LOGIQUE
 */
function update() {
    if(!gameRunning) return;

    // Déplacement Joueur
    player.x += moveInput.x * player.speed;
    player.y += moveInput.y * player.speed;

    // Orientation et Tir
    if(shootInput.active) {
        player.angle = Math.atan2(shootInput.y, shootInput.x);
        if(Math.random() > 0.8) fireBullet(player);
    } else if (Math.abs(moveInput.x) > 0.1) {
        player.angle = Math.atan2(moveInput.y, moveInput.x);
    }

    // Caméra
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    // Gestion de la Zone
    zone.r -= 0.15;
    if(Math.hypot(player.x - zone.x, player.y - zone.y) > zone.r) {
        player.hp -= 0.05;
    }

    // Update Ennemis (IA)
    enemies.forEach(en => {
        en.x += Math.cos(en.targetAngle) * en.speed;
        en.y += Math.sin(en.targetAngle) * en.speed;

        // Rebord monde ou zone pour l'IA
        if(en.x < 0 || en.x > WORLD_SIZE || Math.random() > 0.99) en.targetAngle = Math.random() * Math.PI * 2;

        // Tir IA si proche du joueur
        let d = Math.hypot(player.x - en.x, player.y - en.y);
        if(d < 400 && Date.now() - en.lastShot > 1000) {
            fireBullet(en, player);
            en.lastShot = Date.now();
        }
    });

    // Update Balles
    bullets.forEach((b, i) => {
        b.x += b.vx;
        b.y += b.vy;
        b.life--;

        // Collision balles -> Murs
        obstacles.forEach(o => {
            if(b.x > o.x && b.x < o.x + o.w && b.y > o.y && b.y < o.y + o.h) b.life = 0;
        });

        if(b.life <= 0) bullets.splice(i, 1);
        
        // Collision balles -> Entités
        if(b.owner === 'player') {
            enemies.forEach((en, ei) => {
                if(Math.hypot(b.x - en.x, b.y - en.y) < en.size) {
                    en.hp -= 20;
                    bullets.splice(i, 1);
                    sounds.hit();
                    if(en.hp <= 0) {
                        enemies.splice(ei, 1);
                        player.kills++;
                        showKillFeed("VOUS AVEZ TUÉ UN BOT");
                    }
                }
            });
        } else {
            if(Math.hypot(b.x - player.x, b.y - player.y) < player.size) {
                player.hp -= 5;
                bullets.splice(i, 1);
                sounds.hit();
            }
        }
    });

    // Ramasser Items
    items.forEach((it, i) => {
        if(Math.hypot(player.x - it.x, player.y - it.y) < 30) {
            player.hp = Math.min(100, player.hp + 30);
            items.splice(i, 1);
            sounds.pickup();
        }
    });

    // UI Updates
    document.getElementById('hp-bar').style.width = player.hp + "%";
    document.getElementById('alive-txt').innerText = `VIVANTS: ${enemies.length + 1}`;
    document.getElementById('kills-txt').innerText = `KILLS: ${player.kills}`;

    if(player.hp <= 0) endGame("ÉLIMINÉ");
    if(enemies.length === 0) endGame("BOOYAH!");
}

function fireBullet(who, target = null) {
    let angle = target ? Math.atan2(target.y - who.y, target.x - who.x) : who.angle;
    bullets.push({
        x: who.x, y: who.y,
        vx: Math.cos(angle) * 15,
        vy: Math.sin(angle) * 15,
        life: 60,
        owner: (who === player) ? 'player' : 'bot'
    });
    sounds.shoot();
}

/**
 * RENDU GRAPHIQUE
 */
function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    ctx.translate(-camera.x, -camera.y);

    // Sol (Herbe)
    ctx.fillStyle = "#3a4d24";
    ctx.fillRect(0,0, WORLD_SIZE, WORLD_SIZE);

    // Obstacles (Bâtiments)
    ctx.fillStyle = "#555";
    obstacles.forEach(o => {
        ctx.fillRect(o.x, o.y, o.w, o.h);
        ctx.strokeStyle = "#333"; ctx.lineWidth = 4;
        ctx.strokeRect(o.x, o.y, o.w, o.h);
    });

    // Items
    ctx.fillStyle = "#fff";
    items.forEach(it => {
        ctx.fillRect(it.x-10, it.y-10, 20, 20);
        ctx.fillStyle = "red";
        ctx.fillRect(it.x-2, it.y-8, 4, 16);
        ctx.fillRect(it.x-8, it.y-2, 16, 4);
        ctx.fillStyle = "#fff";
    });

    // Balles
    ctx.fillStyle = "yellow";
    bullets.forEach(b => ctx.fillRect(b.x, b.y, 4, 4));

    // Ennemis
    enemies.forEach(en => {
        ctx.save();
        ctx.translate(en.x, en.y);
        ctx.rotate(en.targetAngle);
        ctx.fillStyle = "red";
        ctx.beginPath(); ctx.arc(0,0, en.size, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black"; ctx.fillRect(10, -5, 15, 10); // Arme
        ctx.restore();
    });

    // Joueur
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);
    ctx.fillStyle = "#3498db";
    ctx.beginPath(); ctx.arc(0,0, player.size, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(8, -5, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "black"; ctx.fillRect(15, -5, 20, 10); // Canon
    ctx.restore();

    // Zone de Danger
    ctx.beginPath();
    ctx.arc(zone.x, zone.y, zone.r, 0, Math.PI*2);
    ctx.strokeStyle = "rgba(255,0,0,0.5)";
    ctx.lineWidth = 10;
    ctx.stroke();

    drawMinimap();
    requestAnimationFrame(() => { update(); draw(); });
}

function drawMinimap() {
    mCtx.fillStyle = "black";
    mCtx.fillRect(0,0,150,150);
    const scale = 150 / WORLD_SIZE;
    
    mCtx.fillStyle = "blue";
    mCtx.fillRect(player.x * scale, player.y * scale, 4, 4);
    
    mCtx.strokeStyle = "red";
    mCtx.beginPath();
    mCtx.arc(zone.x * scale, zone.y * scale, zone.r * scale, 0, Math.PI*2);
    mCtx.stroke();
}

/**
 * UTILITAIRES
 */
function showKillFeed(msg) {
    const kf = document.getElementById('kill-feed');
    kf.innerText = msg;
    setTimeout(() => kf.innerText = "", 3000);
}

function startGame() {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById('overlay').style.display = 'none';
    initGame();
    setupJoysticks();
    gameRunning = true;
    draw();
}

function endGame(msg) {
    gameRunning = false;
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('overlay').innerHTML = `<h1>${msg}</h1><button onclick="location.reload()">REJOUER</button>`;
}

// Handle Resize
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

</script>
</body>
    </html>
